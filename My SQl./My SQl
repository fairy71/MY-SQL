DROP DATABASE IF EXISTS hospital_db;
CREATE DATABASE hospital_db;
USE hospital_db;

CREATE TABLE patients (
    patient_id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(60) NOT NULL,
    last_name VARCHAR(60) NOT NULL,
    gender ENUM('Male','Female','Other') NOT NULL,
    dob DATE NOT NULL,
    phone VARCHAR(15) UNIQUE,
    address TEXT,
    registration_date DATE DEFAULT CURRENT_DATE
);

CREATE TABLE doctors (
    doctor_id INT AUTO_INCREMENT PRIMARY KEY,
    doctor_name VARCHAR(120) NOT NULL,
    specialization VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE,
    salary DECIMAL(10,2),
    joining_date DATE
);

CREATE TABLE departments (
    department_id INT AUTO_INCREMENT PRIMARY KEY,
    department_name VARCHAR(100) UNIQUE NOT NULL,
    floor_no INT CHECK (floor_no > 0)
);

CREATE TABLE rooms (
    room_id INT AUTO_INCREMENT PRIMARY KEY,
    room_type ENUM('General','Semi-Private','Private') NOT NULL,
    charges_per_day DECIMAL(10,2),
    status ENUM('Available','Occupied') DEFAULT 'Available'
);

CREATE TABLE admissions (
    admission_id INT AUTO_INCREMENT PRIMARY KEY,
    patient_id INT,
    doctor_id INT,
    room_id INT,
    admission_date DATE DEFAULT CURRENT_DATE,
    discharge_date DATE,
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id) ON DELETE CASCADE,
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id) ON DELETE SET NULL,
    FOREIGN KEY (room_id) REFERENCES rooms(room_id) ON DELETE SET NULL
);

CREATE TABLE medicines (
    medicine_id INT AUTO_INCREMENT PRIMARY KEY,
    medicine_name VARCHAR(200) NOT NULL,
    brand VARCHAR(100),
    price DECIMAL(10,2)
);

CREATE TABLE prescriptions (
    prescription_id INT AUTO_INCREMENT PRIMARY KEY,
    admission_id INT,
    medicine_id INT,
    dosage VARCHAR(100),
    days INT CHECK (days > 0),
    FOREIGN KEY (admission_id) REFERENCES admissions(admission_id) ON DELETE CASCADE,
    FOREIGN KEY (medicine_id) REFERENCES medicines(medicine_id) ON DELETE CASCADE
);

INSERT INTO patients (first_name, last_name, gender, dob, phone, address)
VALUES
('Amit','Sharma','Male','1985-04-10','8800112233','Delhi'),
('Neha','Verma','Female','1992-11-20','9009988776','Mumbai'),
('Rohan','Khan','Male','1978-06-13','9876532145','Chennai');

INSERT INTO doctors (doctor_name, specialization, email, salary, joining_date)
VALUES
('Dr. Anil Kumar','Cardiologist','anil@hospital.com',90000,'2020-05-01'),
('Dr. Meera Joshi','Neurologist','meera@hospital.com',95000,'2019-09-10'),
('Dr. Ravi Gupta','Orthopedic','ravi@hospital.com',85000,'2021-02-15');

INSERT INTO departments (department_name, floor_no)
VALUES
('Cardiology',2),
('Neurology',3),
('Orthopedics',4);

INSERT INTO rooms (room_type, charges_per_day, status)
VALUES
('General',1500,'Available'),
('Semi-Private',3000,'Available'),
('Private',5000,'Available');

INSERT INTO medicines (medicine_name, brand, price)
VALUES
('Paracetamol','Cipla',20),
('Amoxicillin','Abbott',50),
('Vitamin D','Sun Pharma',30);

INSERT INTO admissions (patient_id, doctor_id, room_id, admission_date)
VALUES
(1,1,3,'2024-01-05'),
(2,2,2,'2024-01-10'),
(3,3,1,'2024-01-12');

INSERT INTO prescriptions (admission_id, medicine_id, dosage, days)
VALUES
(1,1,'2 tablets/day',5),
(1,3,'1 tablet/day',10),
(2,2,'1 capsule/day',7);

-CREATE INDEXES FOR PERFORMANCE

CREATE INDEX idx_patient_phone ON patients(phone);
CREATE INDEX idx_doctor_specialization ON doctors(specialization);
CREATE INDEX idx_admission_patient ON admissions(patient_id);


CREATE VIEW patient_admission_view AS
SELECT 
    p.patient_id,
    CONCAT(p.first_name,' ',p.last_name) AS patient_name,
    d.doctor_name,
    r.room_type,
    a.admission_date,
    a.discharge_date
FROM admissions a
JOIN patients p ON a.patient_id=p.patient_id
JOIN doctors d ON a.doctor_id=d.doctor_id
JOIN rooms r ON a.room_id=r.room_id;

DELIMITER $$

CREATE FUNCTION total_bill(room_charge DECIMAL(10,2), days INT)
RETURNS DECIMAL(10,2)
DETERMINISTIC
BEGIN
    RETURN room_charge * days;
END $$

DELIMITER ;

DELIMITER $$

CREATE PROCEDURE get_patient_bill(IN adm_id INT)
BEGIN
    SELECT 
        p.first_name, 
        p.last_name,
        r.room_type,
        r.charges_per_day,
        DATEDIFF(IFNULL(a.discharge_date,CURRENT_DATE), a.admission_date) AS total_days,
        total_bill(r.charges_per_day,
                   DATEDIFF(IFNULL(a.discharge_date,CURRENT_DATE), a.admission_date))
            AS final_bill
    FROM admissions a
    JOIN patients p ON a.patient_id=p.patient_id
    JOIN rooms r ON a.room_id=r.room_id
    WHERE a.admission_id = adm_id;
END $$

DELIMITER ;

CREATE TABLE patient_logs (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    patient_id INT,
    message TEXT,
    log_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

DELIMITER $$

CREATE TRIGGER log_new_patient
AFTER INSERT ON patients
FOR EACH ROW
BEGIN
    INSERT INTO patient_logs(patient_id, message)
    VALUES (NEW.patient_id, CONCAT('New patient registered: ', NEW.first_name,' ',NEW.last_name));
END $$

DELIMITER ;

SELECT d.doctor_name, COUNT(a.patient_id) AS total_patients
FROM doctors d
LEFT JOIN admissions a ON d.doctor_id = a.doctor_id
GROUP BY d.doctor_id;

SELECT m.medicine_name, COUNT(p.medicine_id) AS times_prescribed
FROM prescriptions p
JOIN medicines m ON p.medicine_id = m.medicine_id
GROUP BY m.medicine_id
ORDER BY times_prescribed DESC;

SELECT p.first_name, p.last_name, a.admission_date
FROM admissions a
JOIN patients p ON a.patient_id = p.patient_id
WHERE a.discharge_date IS NULL;

